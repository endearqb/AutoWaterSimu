<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>交互式报告: ASM1slim.py 代码分析</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Warm Neutrals with Subtle Accents -->
    <!-- Application Structure Plan: The application is structured as a narrative journey through the analysis of ASM1slim.py. It begins with a high-level summary (Executive Summary), then dives into the technical details with three main interactive sections: "核心创新" (Core Innovations), "优化路径" (Optimization Paths), and "功能扩展" (Functional Extensions). This thematic structure was chosen over mirroring the report's linear format to allow users to explore areas of interest non-linearly. A tab-based navigation facilitates easy switching between these deep-dive sections. The user flow encourages starting with the overview, exploring the innovations, then considering future improvements. This design prioritizes user-driven exploration and comprehension of complex technical concepts. -->
    <!-- Visualization & Content Choices: 
        - Executive Summary: Goal=Inform. Method=Key takeaway cards (HTML/Tailwind) for a quick overview. Interaction=None. Justification=Provides a quick, scannable entry point.
        - Core Innovations: Goal=Organize & Inform. Method=An interactive HTML/CSS/JS diagram to visualize the workflow from data to simulation. Interaction=Clicking on function blocks (e.g., `balanceQ`, `balanceParam`) reveals detailed explanations. Justification=Visually explains the computational pipeline, making the abstract tensor-based logic more concrete. A bar chart (Chart.js) compares traditional vs. tensor-based approaches. Goal=Compare. Interaction=Hover for details. Justification=Quantifies the performance advantage discussed in the report.
        - Optimization Paths: Goal=Compare. Method=A dynamic horizontal bar chart (Chart.js) comparing potential optimization techniques (Sparse Tensors, JIT, AMP). Interaction=A slider allows the user to adjust a "Model Complexity" parameter, which dynamically updates the chart to show how the effectiveness of each technique changes. Justification=This interaction demonstrates the trade-offs and context-dependency of performance optimizations in a much more engaging way than a static table.
        - Functional Extensions: Goal=Organize & Inform. Method=An interactive card layout (HTML/Tailwind/JS). Interaction=Clicking on extension cards (e.g., "Extend to ASM2d/3", "Hybrid Modeling") expands to show details, challenges, and potential impact. Justification=Allows users to progressively disclose information, preventing cognitive overload and focusing on one extension at a time.
        - All text is dynamically updated via JavaScript to support the interactions.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', 'Noto Sans SC', sans-serif;
            background-color: #FDFBF8; /* Warm neutral background */
            color: #4A4A4A;
        }
        .tab-active {
            border-bottom: 2px solid #D97706; /* Amber-600 */
            color: #D97706;
            font-weight: 600;
        }
        .tab-inactive {
            border-bottom: 2px solid transparent;
            color: #71717A; /* Zinc-500 */
        }
        .card {
            background-color: #FFFFFF;
            border: 1px solid #F3F4F6; /* Gray-100 */
            transition: all 0.3s ease-in-out;
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
            height: 350px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 400px;
            }
        }
        .flow-diagram-box {
            border: 2px solid #E5E7EB; /* Gray-200 */
            background-color: #F9FAFB; /* Gray-50 */
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .flow-diagram-box.active, .flow-diagram-box:hover {
            border-color: #D97706;
            background-color: #FFFBEB; /* Amber-50 */
        }
        .extension-card.active {
            border-left: 4px solid #D97706;
        }
        .slider-thumb {
          -webkit-appearance: none;
          appearance: none;
          width: 20px;
          height: 20px;
          background: #D97706;
          cursor: pointer;
          border-radius: 50%;
        }
        .slider-track {
          width: 100%;
          height: 8px;
          cursor: pointer;
          background: #E5E7EB;
          border-radius: 4px;
        }
    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
        
        <header class="text-center mb-12">
            <h1 class="text-4xl font-bold text-gray-800 tracking-tight">ASM1slim.py 深度研究</h1>
            <p class="mt-4 text-lg text-gray-600 max-w-3xl mx-auto">一个基于 PyTorch Tensor 的活性污泥模型创新与优化评估的交互式报告</p>
        </header>

        <main>
            <!-- Executive Summary Section -->
            <section id="summary" class="mb-16">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 border-l-4 border-amber-600 pl-4">执行摘要</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="card p-6 rounded-lg shadow-sm">
                        <h3 class="font-bold text-lg mb-2 text-amber-700">核心成就</h3>
                        <p class="text-gray-600">成功将传统ASM1模型与PyTorch结合，全面采用`torch.Tensor`处理水力、物料和生化过程，构建了高效、可扩展的模拟框架。</p>
                    </div>
                    <div class="card p-6 rounded-lg shadow-sm">
                        <h3 class="font-bold text-lg mb-2 text-amber-700">计算优势</h3>
                        <p class="text-gray-600">通过向量化和广播机制，显著简化并加速了物料平衡与生化反应计算，并为GPU并行加速奠定基础。</p>
                    </div>
                    <div class="card p-6 rounded-lg shadow-sm">
                        <h3 class="font-bold text-lg mb-2 text-amber-700">功能潜力</h3>
                        <p class="text-gray-600">PyTorch原生特性为模型扩展、参数敏感性分析、与机器学习混合建模等前沿应用提供了极大便利。</p>
                    </div>
                    <div class="card p-6 rounded-lg shadow-sm">
                        <h3 class="font-bold text-lg mb-2 text-amber-700">交互体验</h3>
                        <p class="text-gray-600">集成的Streamlit界面提升了模型的易用性，但工艺流程的灵活性仍有待通过配置文件等方式增强。</p>
                    </div>
                </div>
            </section>

            <!-- Interactive Tabs Section -->
            <div>
                <div class="border-b border-gray-200 mb-8">
                    <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                        <button id="tab-innovations" class="tab-active whitespace-nowrap py-4 px-1 border-b-2 text-sm font-medium">
                            <span class="text-xl mr-2">💡</span>核心创新
                        </button>
                        <button id="tab-optimizations" class="tab-inactive whitespace-nowrap py-4 px-1 border-b-2 text-sm font-medium">
                            <span class="text-xl mr-2">🚀</span>优化路径
                        </button>
                        <button id="tab-extensions" class="tab-inactive whitespace-nowrap py-4 px-1 border-b-2 text-sm font-medium">
                            <span class="text-xl mr-2">🧩</span>功能扩展
                        </button>
                    </nav>
                </div>

                <!-- Content for Innovations Tab -->
                <div id="content-innovations" class="space-y-12">
                    <section>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">张量化的计算流程</h3>
                        <p class="text-gray-600 mb-6 max-w-3xl">`ASM1slim.py` 的核心是将整个模拟过程抽象为一系列的张量运算。这种方法将传统模型中复杂的循环计算转变为高效的并行矩阵操作。点击下方的模块，可以查看其在计算流程中的作用和优势。</p>
                        
                        <div class="w-full p-4 md:p-6 bg-white rounded-lg shadow-md">
                            <div class="flex flex-col md:flex-row items-center justify-around space-y-4 md:space-y-0 md:space-x-4 text-center">
                                <div id="flow-box-q" class="flow-diagram-box p-4 rounded-lg w-full md:w-1/4">
                                    <h4 class="font-bold text-gray-700">`balanceQ`</h4>
                                    <p class="text-sm text-gray-500">水力平衡</p>
                                </div>
                                <div class="text-2xl text-gray-400 font-mono">&rarr;</div>
                                <div id="flow-box-param" class="flow-diagram-box p-4 rounded-lg w-full md:w-1/4 active">
                                    <h4 class="font-bold text-gray-700">`balanceParam`</h4>
                                    <p class="text-sm text-gray-500">物料平衡</p>
                                </div>
                                <div class="text-2xl text-gray-400 font-mono">&rarr;</div>
                                <div id="flow-box-ode" class="flow-diagram-box p-4 rounded-lg w-full md:w-1/4">
                                    <h4 class="font-bold text-gray-700">`ASM_1_ode_slim`</h4>
                                    <p class="text-sm text-gray-500">生化反应</p>
                                </div>
                                 <div class="text-2xl text-gray-400 font-mono">&rarr;</div>
                                <div id="flow-box-int" class="flow-diagram-box p-4 rounded-lg w-full md:w-1/4">
                                    <h4 class="font-bold text-gray-700">`odeint`</h4>
                                    <p class="text-sm text-gray-500">微分方程求解</p>
                                </div>
                            </div>
                            <div id="flow-explanation" class="mt-6 p-4 bg-amber-50 rounded-lg border border-amber-200 min-h-[120px]">
                                <!-- Explanation text will be injected here by JS -->
                            </div>
                        </div>
                    </section>
                     <section>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">计算范式对比</h3>
                        <p class="text-gray-600 mb-6 max-w-3xl">与传统的基于循环的计算方法相比，`ASM1slim.py` 中基于张量的方法在处理大规模、多反应池的复杂工艺时效率更高。下图直观地展示了在处理物料平衡计算时，两种范式在计算耗时上的理论差异。</p>
                        <div class="chart-container bg-white p-4 rounded-lg shadow-md">
                            <canvas id="paradigmChart"></canvas>
                        </div>
                    </section>
                </div>

                <!-- Content for Optimizations Tab -->
                <div id="content-optimizations" class="hidden space-y-12">
                    <section>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">性能提升策略比较</h3>
                        <p class="text-gray-600 mb-4 max-w-3xl">报告提出了多种性能优化方向，包括稀疏张量、即时编译(JIT)和自动混合精度(AMP)。不同策略的有效性依赖于模型的具体规模和复杂度。请拖动下面的滑块模拟模型复杂度的变化，观察各优化策略的相对效益。</p>
                        
                        <div class="mb-6">
                            <label for="complexity-slider" class="block mb-2 text-sm font-medium text-gray-900">模型复杂度 (如反应池数量)</label>
                            <input id="complexity-slider" type="range" min="1" max="100" value="20" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider-track">
                        </div>
                        
                        <div class="chart-container bg-white p-4 rounded-lg shadow-md">
                            <canvas id="optimizationChart"></canvas>
                        </div>
                    </section>
                </div>

                <!-- Content for Extensions Tab -->
                <div id="content-extensions" class="hidden space-y-8">
                     <section>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">模型功能与扩展性增强</h3>
                        <p class="text-gray-600 mb-6 max-w-3xl">`ASM1slim.py` 的 PyTorch 框架为模型扩展提供了坚实的基础。以下是几个极具潜力的前沿扩展方向。点击卡片展开，了解每个方向的详细信息、技术挑战和潜在影响。</p>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div id="ext-card-asm2" class="extension-card card rounded-lg shadow-sm p-6 cursor-pointer">
                                <h4 class="font-bold text-lg mb-2">扩展至 ASM2d/ASM3</h4>
                                <p class="text-gray-500 text-sm">引入磷动态过程，模拟生物除磷。</p>
                                <div id="ext-details-asm2" class="hidden mt-4 text-sm text-gray-600 space-y-2">
                                    <p><strong>挑战:</strong> 需要深入理解并准确实现更复杂的生物化学机理，如磷的厌氧释放和好氧吸收，并进行细致的模型校准。</p>
                                    <p><strong>影响:</strong> 能够模拟更先进的污水处理工艺，极大拓展模型的应用范围。</p>
                                </div>
                            </div>
                            <div id="ext-card-sensitivity" class="extension-card card rounded-lg shadow-sm p-6 cursor-pointer active">
                                <h4 class="font-bold text-lg mb-2">参数敏感性与不确定性分析</h4>
                                <p class="text-gray-500 text-sm">利用 `torch.autograd` 自动计算梯度。</p>
                                <div id="ext-details-sensitivity" class="mt-4 text-sm text-gray-600 space-y-2">
                                     <p><strong>挑战:</strong> 需要设计合理的损失函数，并实现梯度信息的提取与分析逻辑。</p>
                                     <p><strong>影响:</strong> 极大提升模型分析和校准的效率与能力，是发挥PyTorch框架核心优势的关键。</p>
                                </div>
                            </div>
                            <div id="ext-card-hybrid" class="extension-card card rounded-lg shadow-sm p-6 cursor-pointer">
                                <h4 class="font-bold text-lg mb-2">集成机器学习模型（混合建模）</h4>
                                <p class="text-gray-500 text-sm">用神经网络修正或替代ASM中的不确定模块。</p>
                                <div id="ext-details-hybrid" class="hidden mt-4 text-sm text-gray-600 space-y-2">
                                     <p><strong>挑战:</strong> 涉及神经网络设计、数据准备、以及与机理模型的深度集成与端到端训练，技术复杂度高。</p>
                                     <p><strong>影响:</strong> 显著增强模型对复杂动态的适应性和预测精度，是环境过程建模的前沿研究方向。</p>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const tabs = [
                { id: 'innovations', btn: document.getElementById('tab-innovations'), content: document.getElementById('content-innovations') },
                { id: 'optimizations', btn: document.getElementById('tab-optimizations'), content: document.getElementById('content-optimizations') },
                { id: 'extensions', btn: document.getElementById('tab-extensions'), content: document.getElementById('content-extensions') }
            ];

            tabs.forEach(tab => {
                tab.btn.addEventListener('click', () => {
                    tabs.forEach(t => {
                        t.btn.classList.remove('tab-active');
                        t.btn.classList.add('tab-inactive');
                        t.content.classList.add('hidden');
                    });
                    tab.btn.classList.add('tab-active');
                    tab.btn.classList.remove('tab-inactive');
                    tab.content.classList.remove('hidden');
                });
            });
            
            // --- Innovations Tab Logic ---
            const flowBoxes = {
                q: { 
                    el: document.getElementById('flow-box-q'),
                    text: '<strong>`balanceQ` (水力平衡):</strong> 此函数利用张量转置和求和操作，迭代计算系统内各处理单元间的流量分配，直至达到平衡。虽然包含Python循环，但循环体内的高效张量操作使其优于传统方法。'
                },
                param: { 
                    el: document.getElementById('flow-box-param'),
                    text: '<strong>`balanceParam` (物料平衡):</strong> 这是模型的核心亮点。它利用PyTorch的广播机制和向量化乘法，一次性计算出所有物质在所有流路中的通量，避免了多重嵌套循环，计算效率极高。'
                },
                ode: { 
                    el: document.getElementById('flow-box-ode'),
                    text: '<strong>`ASM_1_ode_slim` (生化反应):</strong> 此函数接收所有池体的水质组分矩阵，并在整个张量上并行执行Monod方程等动力学计算，充分利用CPU或GPU的SIMD优势，实现高效的并行反应速率计算。'
                },
                int: {
                    el: document.getElementById('flow-box-int'),
                    text: '<strong>`torchdiffeq.odeint` (求解器):</strong> 将张量化的微分方程传入此求解器，使得整个求解过程能在PyTorch生态内完成，可无缝利用GPU加速和自动微分功能，为模型优化和敏感性分析提供强大支持。'
                }
            };
            const flowExplanationEl = document.getElementById('flow-explanation');

            function updateFlowExplanation(key) {
                flowExplanationEl.innerHTML = flowBoxes[key].text;
                Object.values(flowBoxes).forEach(box => box.el.classList.remove('active'));
                flowBoxes[key].el.classList.add('active');
            }

            Object.keys(flowBoxes).forEach(key => {
                flowBoxes[key].el.addEventListener('click', () => updateFlowExplanation(key));
            });
            
            updateFlowExplanation('param'); 

            // --- Paradigm Chart ---
            const paradigmCtx = document.getElementById('paradigmChart').getContext('2d');
            const paradigmChart = new Chart(paradigmCtx, {
                type: 'bar',
                data: {
                    labels: ['少量池体', '中等池体', '大量池体'],
                    datasets: [{
                        label: '传统循环计算',
                        data: [10, 80, 500],
                        backgroundColor: '#FBBF24', // Amber-400
                        borderColor: '#D97706', // Amber-600
                        borderWidth: 1
                    }, {
                        label: '张量化并行计算',
                        data: [5, 15, 40],
                        backgroundColor: '#9CA3AF', // Gray-400
                        borderColor: '#6B7280', // Gray-500
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '物料平衡计算耗时对比 (理论)',
                            font: { size: 16 }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.raw} ms`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '相对计算时间 (ms)'
                            }
                        },
                        x: {
                             title: {
                                display: true,
                                text: '模型规模'
                            }
                        }
                    }
                }
            });

            // --- Optimizations Tab Logic ---
            const optimizationCtx = document.getElementById('optimizationChart').getContext('2d');
            let optimizationChart;
            const complexitySlider = document.getElementById('complexity-slider');

            const baseOptimizationData = {
                labels: ['稀疏张量 (Sparse Tensors)', '即时编译 (JIT)', '自动混合精度 (AMP)'],
                baseEffectiveness: [0.2, 0.5, 0.1], 
                complexityFactor: [0.9, 0.4, 0.8] 
            };

            function updateOptimizationChart(complexity) {
                const newData = baseOptimizationData.baseEffectiveness.map((base, i) => {
                    return base + (baseOptimizationData.complexityFactor[i] * complexity / 100);
                });

                if (optimizationChart) {
                    optimizationChart.data.datasets[0].data = newData;
                    optimizationChart.update();
                } else {
                    optimizationChart = new Chart(optimizationCtx, {
                        type: 'bar',
                        data: {
                            labels: baseOptimizationData.labels,
                            datasets: [{
                                label: '相对性能提升潜力',
                                data: newData,
                                backgroundColor: ['#FBBF24', '#F97316', '#EA580C'],
                                borderColor: ['#D97706', '#D97706', '#D97706'],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            indexAxis: 'y',
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                title: {
                                    display: true,
                                    text: '各优化策略的性能提升潜力',
                                    font: { size: 16 }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return ` 潜力: ${(context.raw * 100).toFixed(0)}%`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    beginAtZero: true,
                                    max: 2.0,
                                    title: {
                                        display: true,
                                        text: '性能提升因子'
                                    }
                                }
                            }
                        }
                    });
                }
            }
            
            complexitySlider.addEventListener('input', (e) => {
                updateOptimizationChart(parseInt(e.target.value));
            });
            
            updateOptimizationChart(parseInt(complexitySlider.value));

            // --- Extensions Tab Logic ---
            const extensionCards = [
                { id: 'asm2', card: document.getElementById('ext-card-asm2'), details: document.getElementById('ext-details-asm2') },
                { id: 'sensitivity', card: document.getElementById('ext-card-sensitivity'), details: document.getElementById('ext-details-sensitivity') },
                { id: 'hybrid', card: document.getElementById('ext-card-hybrid'), details: document.getElementById('ext-details-hybrid') }
            ];
            
            function toggleExtensionDetails(selectedId) {
                extensionCards.forEach(item => {
                    if (item.id === selectedId) {
                        item.card.classList.add('active');
                        item.details.classList.remove('hidden');
                    } else {
                        item.card.classList.remove('active');
                        item.details.classList.add('hidden');
                    }
                });
            }

            extensionCards.forEach(item => {
                item.card.addEventListener('click', () => {
                    toggleExtensionDetails(item.id);
                });
            });

            toggleExtensionDetails('sensitivity');

        });
    </script>
</body>
</html>
