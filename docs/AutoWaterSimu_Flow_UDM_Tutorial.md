# AutoWaterSimu：流程图仿真与自定义模型(UDM) 实战通关教程

**目标读者**：初级水处理工艺/研发工程师（懂基本工艺与水质指标，但不熟悉数值仿真计算）。
**教程目标**：带你从工程业务场景出发，掌握软件的**流程图建模 (Flow)** 与 **自定义矩阵驱动引擎 (UDM)**，最终能独立搭建出可运行、能排错的动态污水处理水力生化模型。

---

## 模块一：概念认知与“水力骨架”搭建 (Flow)

在这个模块中，我们将学习如何通过**图形化拖拽和连线**，在画布上搭建出水处理厂的水力与混合骨架（即确定“反应舞台”）。

### 1.1 界面概览：“水处理电子沙盘”
把软件界面想象成你的工艺沙盘。
* **节点 (Nodes)**：水力构筑物（如 CSTR 完全混合池、进水边界、出水边界、管网分流/合流）。
* **连线 (Edges)**：管道，代表着流量、物质的绝对通量或控制信号。

> **[🖼️ 截图提示：展示 AutoWaterSimu 的主界面，分别用红框标注出“左侧组件库区”、“中间主编辑画布区”和“右侧节点属性与参数设置面板”。]**

### 1.2 实战演练：搭建第一个完全混合池 (CSTR)
**任务**：建立 1个进水 + 1个完全混合池 + 1个出水，模拟某种物质浓度的动态稀释过程。

**操作步骤**：
1. **布置进水与出水点**：从左侧边栏分别将“进水边界”与“出水边界”推拽至画布。
2. **布置核心反应器**：从组件库拖入一个“完全混合池(CSTR)”节点放在中间。
3. **连接流向**：将“进水”连向“反应池”，再将“反应池”连向“出水”。
   > **[🎥 视频录制提示：清晰录制鼠标按住进水节点右侧的“输出端口”，拉出一条虚线准确连接到CSTR左侧“输入端口”的动态过程。此时可用旁白或字幕强调：“水流方向（箭头）不能接反！”]**
4. **设置单位与边界参数（非常关键！）**：
   * 点击进水节点，在右侧面板设置：流量定为 `1000 m³/d`，并设定特定的进水 COD 浓度（例如 `200 mg/L`）。
   * 点击 CSTR 节点，在属性面板设置池体有效容积为 `5000 m³`。（此时水力停留时间 HRT 等于 5000/1000 = 5 天）。
   * **⚠️ 守恒三件套自检**：请在开始计算前，确认全场的单位体系是统一的。我们强烈推荐：**流量统一步伐用 `m³/d`，浓度统一步伐用 `mg/L`。混用 `m³/h` 和 `m³/d` 是初学者最容易犯的致命错误！**
   > **[📷 截图提示：右侧属性面板的特写大图，用荧光色高亮“流量”、“体积”输入框以及它们旁边的“单位下拉菜单选项”。]**

### 1.3 运行、观测与工程诊断
**操作步骤**：
1. 点击顶部的“▶️ 运行仿真”按钮。
2. 在底部的输出图表中，勾选查看出水口的 COD 浓度随时间变化的模拟曲线。
   > **[🎥 视频录制提示：从鼠标点击“运行”开始，展示进度条走动，然后平滑切换到底部图表(Chart)界面，勾选目标变量后，曲线动态渲染出现的全过程。]**
3. **工程师诊断练习**：如果运行完发现——“CSTR 里的稳态浓度居然大于进水浓度”，这符合物理常识吗？你会怎么排查？
   * **💡 错因库速查**：
     - 去排查进水连线的箭头方向是否接反了？导致水根本没进去而是形成了倒灌？
     - 检查进水量的时间基准（比如你误把 1000 m³/h 写成了 1000 m³/d）和池体容积基准是否错位。

---

## 模块二：剧本编写 - 自定义过程模型 (UDM)

如果说流程图是“舞台”，那么其背后的反应过程就是“剧本”。AutoWaterSimu 强大的 **UDM 引擎** 基于学术界标杆的 **Petersen 矩阵** 思想，能让你不用写 C++ 代码，就将生化公式转化为可计算软件模块。

### 2.1 揭开“矩阵驱动”的面纱
不要被“矩阵”这个词吓到，其实它就是一张逻辑严密的超级表格：
* **纵向列 (Columns - 状态变量)**：代表会被浓度改变的物质（比如：COD/S_S、溶解氧 DO、活性污泥类群 X_H）。
* **横向行 (Rows - 反应过程)**：代表发生的反应事件（比如：异养菌的生长耗氧过程）。
* **表格交叉格子 (化学计量系数)**：这是反应的比例尺（生成产物填正数，消耗底物填负数）。
* **最右侧独立列 (反应速率方程 Rate)**：决定这个过程进行得有多快。

> **[🖼️ 截图提示：展示一次完整的 UDM 矩阵编辑器界面。标注出左侧的“状态量列表”、表格主体的“计量系数区”以及右侧单独一栏的“反应速率区”。]**

### 2.2 实战演练：写一个简易好氧生化降解过程
**任务**：定义一个最小闭环反应。活性污泥微粒 `X`，消耗水中的溶解氧 `DO` 来降解有机底物 `S`。

**操作步骤**：
1. **新建模板**：在 UDM 模型库中新建一个空白算法模块。
2. **定义状态量 (Variables)**：
   * 在状态列表添加 `S` (可溶性底物)，`X` (活性生物量)，`DO` (溶解氧)。
3. **编写过程速率 (Rate Expression)**：
   * 新建一行，命名为“好氧降解”。
   * 在最右侧输入基于 Monod 理论的经典公式：`Rate = \mu * (S / (K_s + S)) * X`。
   > **[🎥 视频录制提示：录制在单元格内键入公式的代码高亮过程。重点展示 AutoWaterSimu 的智能特性——当你输入未定义过的参数(如μ)时，系统自动识别并弹窗提示“是否新增全局参数\mu，并设置其默认范围”的便捷操作。]**
4. **填写计量数网格 (Stoichiometry)**：
   * 找到 `S` 对应的列，填入：`-1 / Y_H` （表示由于增殖伴随着底物的消耗，Y_H为产率参数）。
   * 找到 `X` 对应的列，填入：`1` （表示自身因为生长生成了 1 个单位）。
   * 找到 `DO` 对应的列，填入：`-(1 - Y_H) / Y_H` （表示消耗掉的氧气量）。

### 2.3 “形神合一”：将 UDM 挂载到主流程图中
写好了生化剧本，怎么让刚才第一章建好的物理舞台(CSTR)演起来？
1. 返回沙盘主画布，鼠标选中第一章的核心 CSTR 节点。
2. 在右侧属性面板找到“挂载生化计算模块(UDM)”的选项卡，选中刚刚保存好的自定义文件。
3. 此时，神奇的事情发生了——软件会自动将 UDM 里设定好的机理参数（如最大生长速率 `\mu`，半饱和常数 `K_s` 等）提取出来，变成直观的属性控制滑块。
   > **[🎥 视频录制提示：录制将 UDM 下拉选中绑定到 CSTR 节点的操作。镜头拉近到右侧参数面板：原本空白的地方动态弹出了一排带数值和范围的滑块(Sliders)，用鼠标轻轻拖动其中一个滑块，展现参数配置的灵活性。]**

---

## 模块三：高手进阶与护城河 - 拯救“爆炸曲线”

水处理模型的工程化落地，一半精力在标定调参，一半精力在查 Bug 排错。学会定位“计算爆炸”，是新手的成人礼。

### 3.1 识别模型异常崩溃 
当你点击运行，如果输出窗口弹出警告，或者发现某条浓度图表曲线笔直地穿透零点飞速飙升到不可思议的负数或出现 "NaN / Infinity"（无意义乱码），这时候你的计算“爆炸 (Blow up)”了。
> **[🖼️ 截图提示：制作一张刻意的反面教材截图：一条曲线呈“锯齿形极限振荡”或者“断崖式掉入副坐标”的特征曲线图，打上醒目的大红叉 ❌。]**

### 3.2 错因定位 SOP (标准作业指导)
出现报错时，不要慌张，按以下顺序打勾自检：
1. **步长太长造成刚性系统震荡？**
   * *排查动作*：因为生化反应太快或水池太小造成微分方程极其“刚硬”。试着去顶部的“仿真引擎设置”里，将积分步长 `Time Step` 调小一个数量级（比如从 0.01 降到 0.001）。如果曲线瞬间不震荡了，说明模型结构没问题，只是数值计算问题。
   * **[🎥 视频录制提示：打开仿真器设置(Solver Settings)弹框，演示修改步长参数选项，重新点击运行，曲线由疯狂震荡变得平滑圆润。]**
2. **速率公式有没有漏掉“边界截断”？**
   * *排查动作*：回去看你的 UDM 剧本。当溶解氧 `DO` 或底物 `S` 耗尽时，你的速率是否会强制归零？如果没有基于 `DO/(K_{DO}+DO)` 这种开关函数，很容易发生“已经没氧气了它还在疯狂反应扣减浓度”，最终抽出负数浓度值致使程序崩溃。
3. **再次警惕单位“刺客”？**
   * *排查动作*：检查你的过程速率公式里的比生长速率参数 \mu ，你查阅文献填写的是 `1/h` 还是 `1/d`？如果模型系统主干的全局时间基准是 `天(d)`，而在 UDM 中误用成了小时制的数值，生化反应的速度瞬间被人工放快了 24 倍！当然会引发雪崩式的爆炸。

---

## 结语与课后挑战练习

恭喜你！完成这套最小闭环，你已经超越了只会死背水质参数的工程师，具备了将物理现实抽象进软件底层的能力。

**👇 布置你的动手小挑战**：
1. **基础任务 (Flow练习)**：在画布的进水节点和 CSTR 节点之间，试着加一个“分流节点 (Splitter)”，随便设置一个分流比例，看最终稳态浓度会有何变化？
2. **进阶任务 (UDM练习)**：重新打开你的 UDM 表格，为其增加第二行反应：即加入微生物自身的“内源呼吸与衰减细胞裂解死亡”过程。试试看参数怎么配平！

> **[🎥 视频录制提示：以一幅拥有多个串联反应池、包含污泥回流线与内回流线、整体结构丰满专业的大型全流程污水厂仿真动态画面作为背景，配合缓慢的推拉镜头，给观众留下震撼的结尾印象。]**
