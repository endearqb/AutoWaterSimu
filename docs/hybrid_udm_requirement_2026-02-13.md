# Hybrid（仅 UDM）功能需求文档

版本：v1.0  
日期：2026-02-13  
状态：已确认（待开发）  
适用范围：AutoWaterSimu `my-full-stack` 仓库

## 1. 背景

当前系统已具备：
- UDM 模型编辑与保存能力。
- UDM 模型模板能力（包含 ASM1/ASM1Slim/ASM3 模板）。
- 流程图仿真与分段时间输入能力。

当前待解决的问题：
- 用户希望在同一张流程图中组合多个不同 UDM 模型。
- 不同 UDM 模型变量存在重叠与不重叠，必须有明确映射与计算语义。

## 2. 目标

一期目标：
- 只接入 UDM，不新增 ASM1/ASM1Slim/ASM3 独立节点类型。
- 在 Hybrid 模式中，用户从 UDM 模型库选择多个模型进入同一流程图。
- 在进入流程图前完成模型间变量映射（模型对映射）。
- 映射规则全图复用，支持一次仿真内多模型协同。

## 3. 非目标（一期不做）

- 不直接开放 ASM1/ASM1Slim/ASM3 独立节点到 Hybrid 页面。
- 不做按边单独映射（仅支持模型对全局映射）。
- 不做智能自动语义匹配（如 AI 自动猜测同义变量）。
- 不做跨模型自动参数校准与优化。

## 4. 核心术语

- `UDM模型`：用户在 UDM 模型编辑页保存的模型（含模板实例化模型）。
- `模型对映射`：源模型到目标模型的变量映射规则（A->B）。
- `焦集变量`：目标模型速率方程中实际使用的变量集合。
- `惰性变量`：不在当前节点速率方程中使用，仅受传输项影响的变量。

## 5. 用户流程

1. 用户进入 Hybrid（UDM）入口页。
2. 选择要参与混合流程图的 UDM 模型（可多选，锁定版本）。
3. 配置模型对映射（A->B）并通过校验。
4. 进入 Hybrid 流程图画布。
5. 拖拽 UDM 节点并为节点指定已选模型。
6. 配置边、时段参数并发起仿真。
7. 查看结果（按节点/变量/模型过滤）。

## 6. 功能需求

### FR-01 模型选择
- 系统必须展示当前用户可访问的 UDM 模型列表（含版本信息）。
- 用户可选择多个模型，进入本次 Hybrid 会话上下文。
- 选择结果必须可持久化到流程图 `flow_data`。

### FR-02 模型变量抽取
- 系统必须从每个所选 UDM 模型快照提取变量清单。
- 系统必须标识每个模型的焦集变量（用于速率方程）。

### FR-03 模型对映射配置
- 系统必须支持配置 `源模型变量 -> 目标模型变量` 的映射。
- 映射配置粒度固定为模型对，不支持边级独立映射。
- 同一模型对允许维护一份生效映射（可覆盖更新）。

### FR-04 映射校验
- 映射校验至少包括：
- 源变量存在性。
- 目标变量存在性。
- 焦集变量覆盖度（目标模型焦集变量需逐一映射或明确豁免）。
- 冲突检测（同一源变量映射到多个不兼容目标时提示）。
- 校验失败时必须阻断进入画布或阻断仿真提交。

### FR-05 画布节点约束
- Hybrid（UDM）画布仅允许：
- `input`
- `output`
- `default`
- `udm`
- 每个 `udm` 节点必须绑定一个已选 UDM 模型版本。

### FR-06 全局映射复用
- 当存在边连接 `模型A节点 -> 模型B节点` 时，系统必须自动应用 `A->B` 模型对映射。
- 映射不得要求用户在每条边重复配置。

### FR-07 仿真计算语义
- 节点浓度变化由两部分组成：
- 传输项：进出水与体积变化导致的浓度变化（对状态向量中的全部变量生效）。
- 反应项：模型速率方程导致的浓度变化（仅对该模型焦集变量生效）。
- 非焦集变量在该节点不叠加反应项，作为惰性变量随传输项演化。

### FR-08 分段时间兼容
- 现有 `timeSegments` 语义保持不变。
- 时段覆盖仅影响边参数，不改变模型对映射。

### FR-09 保存与复现
- 流程图保存时必须包含：
- 所选模型列表（含版本）
- 模型对映射快照
- 节点模型绑定关系
- 任务提交时必须保存模型与映射快照，保证历史任务可复现。

### FR-10 结果展示
- 结果页需支持按变量查看跨模型节点时序。
- 至少支持：节点过滤、变量过滤、模型过滤。

## 7. 数据结构需求（建议）

在 `flow_data` 顶层新增 `hybrid_config`：

```json
{
  "hybrid_config": {
    "mode": "udm_only",
    "selected_models": [
      {
        "model_id": "uuid",
        "version": 3,
        "name": "ASM1-template-custom",
        "hash": "sha256:..."
      }
    ],
    "model_pair_mappings": {
      "modelA@3->modelB@2": {
        "source_model_id": "modelA",
        "source_version": 3,
        "target_model_id": "modelB",
        "target_version": 2,
        "variable_map": [
          {
            "source_var": "S_NH",
            "target_var": "NH4",
            "enabled": true
          }
        ]
      }
    }
  }
}
```

节点 `data` 建议新增：
- `udmModelId`
- `udmModelVersion`
- `udmModelHash`

## 8. 校验规则

- `selected_models` 不能为空。
- `udm` 节点绑定的模型必须属于 `selected_models`。
- 任意存在连接关系的模型对必须存在映射定义。
- 焦集变量必须被覆盖映射或在规则中标记为“本地固定/豁免”。
- 任一映射失效（模型版本变更、变量消失）时，流程图状态标记为“需修复映射”。

## 9. 非功能需求

- 性能：同规模下计算耗时劣化不超过 20%（相对于单 UDM 图）。
- 可观测性：日志包含模型数量、映射数量、未覆盖焦集变量数量。
- 可维护性：映射校验和映射应用逻辑必须模块化，避免耦合到 UI。

## 10. 权限与安全

- 模型选择仅允许当前用户有权限访问的 UDM 模型。
- 任务快照中的模型定义需按现有 owner 规则隔离。

## 11. 验收标准（DoD）

1. 用户可选择多个 UDM 模型进入同一 Hybrid 画布。
2. 可完成模型对映射配置并通过校验。
3. 同一模型对映射在全图自动复用，无需边级重复配置。
4. 仿真结果符合“传输项全变量 + 反应项焦集变量”语义。
5. 含 `timeSegments` 的 Hybrid 图可正常计算。
6. 历史 UDM 单模型图可继续运行且结果不回退。
