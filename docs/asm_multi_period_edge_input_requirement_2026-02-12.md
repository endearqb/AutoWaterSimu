# ASM 多时段边参数输入需求文档（一期）

版本：v1.0  
日期：2026-02-12  
状态：需求已确认（待开发排期）

## 1. 背景
当前 ASM 系列仿真一次仅支持一组固定输入，无法表达实际运行中的分时段工况变化。实际业务需要在同一次仿真中按时段切换边参数，例如不同时间段的流量、`a`、`b` 参数。

## 2. 目标
- 在一次仿真中支持多时段配置。
- 每个时段可对边参数进行覆盖。
- 保持与当前单组输入模式兼容。
- 在结果图中清晰展示时段边界与参数变更信息。

## 3. 一期范围（In Scope）
- 多时段配置采用“分段常值 + 边界阶跃变化”。
- 时段必须覆盖全程仿真时长。
- 可变参数仅限边参数：
  - `flow`
  - `param_a`
  - `param_b`
- 允许所有边可变，但默认不覆盖（即沿用基线值）。
- 结果图支持可选择显示：
  - 时段分割线
  - 参数变更注记

## 4. 非一期范围（Out of Scope）
- 周期模板（例如 24h 循环）不纳入一期。
- 平滑过渡（线性/样条）不纳入一期。
- 节点参数随时段变化不纳入一期。

## 5. 核心术语
- 基线值：流程图中当前保存的边参数值（无时段覆盖时使用）。
- 时段（Segment）：一个时间区间内参数恒定。
- 覆盖（Override）：在某时段中替换基线值的局部参数定义。
- 阶跃切换：时段边界处参数立即切换，无过渡。

## 6. 业务规则
1. 时段必须从 `0` 开始，结束于 `hours`，且连续无重叠无空洞。
2. 推荐采用区间语义 `[start, end)`，最后一段为 `[start, hours]`。
3. 未配置覆盖的边参数自动继承基线值。
4. 每个时段仅允许对 `flow/param_a/param_b` 设置覆盖。
5. 若未传时段配置，系统按当前“单组输入”逻辑执行。

## 7. 前端交互需求
1. 在仿真相关面板提供“时段计划”全局入口（不绑定单个节点）。
2. 支持时段新增、删除、复制、排序与时间编辑。
3. 支持按“边-参数”配置覆盖值；未覆盖项保持空（表示继承）。
4. 提交前校验：
   - 覆盖全程
   - 无重叠/无空洞
   - 时间合法（`start < end`）
5. 结果图支持两个可切换开关：
   - 显示时段分割线
   - 显示参数变更注记

## 8. 数据结构建议（Flowchart 扩展）
在现有 flowchart 顶层新增 `timeSegments` 字段：

```json
{
  "calculationParameters": {
    "hours": 24,
    "steps_per_hour": 4
  },
  "timeSegments": [
    {
      "id": "seg_1",
      "start_hour": 0,
      "end_hour": 12,
      "edge_overrides": {
        "edge_1": { "flow": 5000, "param_a": 120, "param_b": 30 },
        "edge_2": { "flow": 800 }
      }
    },
    {
      "id": "seg_2",
      "start_hour": 12,
      "end_hour": 24,
      "edge_overrides": {
        "edge_1": { "flow": 4200, "param_a": 90, "param_b": 18 }
      }
    }
  ]
}
```

说明：
- `edge_overrides` 中省略的参数表示不覆盖。
- `timeSegments` 为空或缺失时，等价于单段全程基线计算。

## 9. 后端计算语义
1. 按 `timeSegments` 将总仿真拆分为多个子区间。
2. 每段计算前，将“基线边参数 + 当前段覆盖”合成段内参数。
3. 段间串联：上一段末状态作为下一段初值。
4. 每段内部参数恒定，边界执行阶跃切换。
5. 合并段结果为连续时间序列输出。

## 10. 结果输出增强
在结果数据中新增可视化辅助信息（建议）：
- `segment_markers`：时段边界时间点列表。
- `parameter_change_events`：每个边界发生变化的边与参数摘要。

## 11. 存储与兼容策略
- 一期不强制改数据库表结构，沿用 JSON 字段（`input_data/result_data/summary_data`）存储扩展信息。
- 历史任务无 `timeSegments` 时按旧逻辑读取与回放。
- 前端导入/回显必须无损保留 `timeSegments`。

## 12. 验收标准（DoD）
1. 无 `timeSegments` 时，结果与当前版本一致。
2. 有 `timeSegments` 时，边界前后参数按配置生效，且时间序列连续。
3. 所有边均可配置覆盖，默认不覆盖可正常继承。
4. 时段配置无法通过非法提交（重叠、空洞、未覆盖全程）。
5. 结果图可开关显示“分割线/注记”。

## 13. 后续规划占位（二期）
- 增加周期模板能力（例如每日周期重复）。
- 增加时段模板复用（工作日/周末）。
- 可选插值切换策略（线性过渡等）。
